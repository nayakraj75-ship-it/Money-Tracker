<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidated Wealth Tracker (₹)</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js CDN for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Define custom theme colors */
        :root {
            --color-primary-blue: #3F51B5;
            --color-light-grey: #FAFAFA;
        }
        /* Use Inter font and light grey background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-light-grey);
            padding-top: 64px; /* Space for the fixed header */
        }
        /* Custom Tailwind Configuration */
        .primary-bg { background-color: var(--color-primary-blue); }
        .primary-text { color: var(--color-primary-blue); }
        .primary-border { border-color: var(--color-primary-blue); }
        .primary-hover:hover { background-color: #31409d; } /* Slightly darker hover */
        .card { @apply bg-white p-4 rounded-xl shadow-lg transition duration-300 ease-in-out hover:shadow-xl; }
        .input-style { @apply w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[--color-primary-blue] focus:border-[--color-primary-blue]; }
    </style>
</head>
<body>

    <!-- Sticky Header -->
    <header class="fixed top-0 left-0 w-full primary-bg text-white shadow-2xl z-50">
        <div class="container mx-auto p-4 flex justify-between items-center max-w-7xl">
            <h1 class="text-xl sm:text-2xl font-bold tracking-tight">Consolidated Wealth Tracker (₹)</h1>
            <button id="clearDataBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-lg font-medium text-sm transition duration-150 shadow-md">
                Clear All Data
            </button>
        </div>
    </header>

    <!-- Global Status Message Container (Replaces alert()) -->
    <div id="statusMessageContainer" class="fixed top-20 right-4 p-3 rounded-lg shadow-xl text-white z-[100] transition-opacity duration-300 opacity-0 pointer-events-none" style="min-width: 250px;">
        <p id="statusMessageText" class="font-medium"></p>
    </div>

    <!-- Confirmation Modal for Clearing Data -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full card">
            <h2 class="text-xl font-bold mb-4 text-red-600">Confirm Data Deletion</h2>
            <p class="mb-6">Are you sure you want to delete **ALL** application data (transactions, assets, budgets, and categories)? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelClearBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirmClearBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, Clear All</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 max-w-7xl">

        <!-- Financial Overview (Dashboard) -->
        <section class="mb-10">
            <h2 class="text-3xl font-extrabold primary-text mb-6 border-b pb-2">Financial Overview</h2>

            <!-- Net Worth Card -->
            <div class="card p-6 mb-8 primary-bg text-white shadow-2xl">
                <p class="text-lg font-semibold mb-1 opacity-90">Current Net Worth (Assets - Liabilities)</p>
                <div id="netWorthDisplay" class="text-5xl font-bold tracking-tight">₹0.00</div>
            </div>

            <!-- Summary Cards -->
            <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-10">
                <!-- Cards will be populated here -->
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-4">
                    <h3 class="text-xl font-semibold mb-4 primary-text">Expenses by Category</h3>
                    <div class="h-64 flex justify-center items-center">
                        <canvas id="expensesChart"></canvas>
                    </div>
                </div>
                <div class="card p-4">
                    <h3 class="text-xl font-semibold mb-4 primary-text">Stock Portfolio Composition</h3>
                    <div class="h-64 flex justify-center items-center">
                        <canvas id="stocksChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- --- -->

        <!-- Income & Expense Tracker (Transactions) -->
        <section class="my-10">
            <h2 class="text-3xl font-extrabold primary-text mb-6 border-b pb-2">Record New Transaction</h2>
            <div class="card mb-8">
                <form id="transactionForm" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                    <!-- Date -->
                    <div>
                        <label for="transDate" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="transDate" required class="input-style">
                    </div>
                    <!-- Type -->
                    <div>
                        <label for="transType" class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="transType" required class="input-style">
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <!-- Category -->
                    <div>
                        <label for="transCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="transCategory" required class="input-style">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <!-- Description -->
                    <div class="lg:col-span-1">
                        <label for="transDesc" class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="transDesc" required placeholder="e.g., Dinner at ABC" class="input-style">
                    </div>
                    <!-- Amount -->
                    <div>
                        <label for="transAmount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                        <input type="number" id="transAmount" required min="0.01" step="0.01" placeholder="500.00" class="input-style">
                    </div>
                    <!-- Submit -->
                    <div class="lg:col-span-1 flex items-end">
                        <button type="submit" class="w-full primary-bg text-white font-semibold py-2 rounded-lg primary-hover transition duration-150 shadow-md">
                            Add Transaction
                        </button>
                    </div>
                </form>
            </div>

            <h3 class="text-2xl font-bold primary-text mb-4">Recent Transactions</h3>
            <div class="overflow-x-auto card">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="px-3 py-3">Date</th>
                            <th class="px-3 py-3">Type</th>
                            <th class="px-3 py-3">Category</th>
                            <th class="px-3 py-3">Description</th>
                            <th class="px-3 py-3 text-right">Amount (₹)</th>
                            <th class="px-3 py-3"></th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Transactions will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- --- -->

        <!-- Monthly Budget Tracker -->
        <section class="my-10">
            <h2 class="text-3xl font-extrabold primary-text mb-6 border-b pb-2">Monthly Budget Tracker</h2>

            <!-- Set Monthly Net Income -->
            <div class="card mb-6">
                <h3 class="text-xl font-semibold mb-3">Set Monthly Net Income (Salary)</h3>
                <form id="incomeBudgetForm" class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="monthlyIncome" class="block text-sm font-medium text-gray-700">Income (₹)</label>
                        <input type="number" id="monthlyIncome" required min="0" step="100" placeholder="e.g., 80000" class="input-style">
                    </div>
                    <button type="submit" class="sm:w-auto w-full primary-bg text-white font-semibold py-2 px-4 rounded-lg primary-hover transition duration-150 shadow-md">
                        Set Income
                    </button>
                </form>
            </div>

            <!-- Set Category Budget Limits -->
            <div class="card mb-8">
                <h3 class="text-xl font-semibold mb-3">Set Expense Category Budget Limits</h3>
                <form id="budgetLimitForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Category Dropdown -->
                    <div>
                        <label for="budgetCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="budgetCategory" required class="input-style">
                            <!-- Populated by JS with Expense categories only -->
                        </select>
                    </div>
                    <!-- Limit Amount -->
                    <div>
                        <label for="budgetLimit" class="block text-sm font-medium text-gray-700">Limit (₹)</label>
                        <input type="number" id="budgetLimit" required min="0" step="10" placeholder="e.g., 5000" class="input-style">
                    </div>
                    <!-- Submit -->
                    <div class="flex items-end">
                        <button type="submit" class="w-full primary-bg text-white font-semibold py-2 rounded-lg primary-hover transition duration-150 shadow-md">
                            Set Limit
                        </button>
                    </div>
                </form>
            </div>

            <!-- Budget Progress Display -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold primary-text mb-4">Current Monthly Budget Status</h3>
                <p id="totalMonthlyIncomeDisplay" class="text-lg font-medium mb-4">Monthly Net Income Set: <span class="font-bold">₹0.00</span></p>
                <div id="budgetProgressContainer" class="space-y-4">
                    <!-- Progress bars will be populated here -->
                    <!-- The placeholder <p id="noBudgetSet"> is now managed by JS to fix the null error -->
                </div>
            </div>
        </section>

        <!-- --- -->

        <!-- Asset Management (Banks and Stocks) -->
        <section class="my-10 grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- 5. Bank Accounts (Assets) -->
            <div>
                <h2 class="text-3xl font-extrabold primary-text mb-6 border-b pb-2">Bank Accounts (Assets)</h2>
                <div class="card mb-6">
                    <h3 class="text-xl font-semibold mb-3">Add Bank Account</h3>
                    <form id="bankForm" class="space-y-3">
                        <input type="text" id="bankName" required placeholder="Account Name (e.g., SBI Savings)" class="input-style">
                        <select id="bankType" required class="input-style">
                            <option value="" disabled selected>Select Account Type</option>
                            <option value="Savings">Savings</option>
                            <option value="Checking">Checking</option>
                            <option value="Credit Card">Credit Card (as Liability - use negative balance)</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="number" id="bankBalance" required placeholder="Current Balance (₹, e.g., 50000)" step="0.01" class="input-style">
                        <button type="submit" class="w-full primary-bg text-white font-semibold py-2 rounded-lg primary-hover transition duration-150 shadow-md">
                            Add/Update Bank Account
                        </button>
                    </form>
                </div>
                <div class="card">
                    <h3 class="text-2xl font-bold primary-text mb-4">Current Bank Balances</h3>
                    <div id="bankList" class="space-y-3">
                        <!-- Bank accounts will be populated here -->
                        <!-- The placeholder <p id="noBanks"> is now managed by JS to fix the null error -->
                    </div>
                </div>
            </div>

            <!-- 6. Stock Portfolio Tracker (Assets) -->
            <div>
                <h2 class="text-3xl font-extrabold primary-text mb-6 border-b pb-2">Stock Portfolio Tracker (Assets)</h2>
                <div class="card mb-6">
                    <h3 class="text-xl font-semibold mb-3">Add Stock Portfolio</h3>
                    <form id="stockForm" class="space-y-3">
                        <input type="text" id="stockPlatform" required placeholder="Platform Name (e.g., Zerodha, Groww)" class="input-style">
                        <input type="number" id="stockInvested" required min="0" step="0.01" placeholder="Total Invested Amount (₹)" class="input-style">
                        <input type="number" id="stockValue" required min="0" step="0.01" placeholder="Current Market Value (₹)" class="input-style">
                        <button type="submit" class="w-full primary-bg text-white font-semibold py-2 rounded-lg primary-hover transition duration-150 shadow-md">
                            Add/Update Portfolio
                        </button>
                    </form>
                </div>
                <div class="card">
                    <h3 class="text-2xl font-bold primary-text mb-4">Portfolio Summary</h3>
                    <div id="stockSummary" class="mb-4 grid grid-cols-3 gap-4 text-center text-sm font-medium">
                        <div class="p-2 border rounded-lg">Invested: <span id="totalInvested" class="font-bold block">₹0.00</span></div>
                        <div class="p-2 border rounded-lg">Current Value: <span id="currentTotalValue" class="font-bold block">₹0.00</span></div>
                        <div class="p-2 border rounded-lg">Total P&L: <span id="totalPnL" class="font-bold block text-gray-600">₹0.00</span></div>
                    </div>
                    <div id="stockList" class="space-y-3">
                        <!-- Stock portfolios will be populated here -->
                        <!-- The placeholder <p id="noStocks"> is now managed by JS to fix the null error -->
                    </div>
                </div>
            </div>
        </section>

        <!-- --- -->

        <!-- 2. Custom Category Management -->
        <section class="my-10">
            <h2 class="text-3xl font-extrabold primary-text mb-6 border-b pb-2">Custom Category Management</h2>

            <div class="card mb-8">
                <h3 class="text-xl font-semibold mb-3">Add New Custom Category</h3>
                <form id="categoryForm" class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="categoryName" class="block text-sm font-medium text-gray-700">Category Name</label>
                        <input type="text" id="categoryName" required placeholder="e.g., Pet Supplies" class="input-style">
                    </div>
                    <div class="w-full sm:w-1/3">
                        <label for="categoryType" class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="categoryType" required class="input-style">
                            <option value="Expense">Expense</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <button type="submit" class="sm:w-auto w-full primary-bg text-white font-semibold py-2 px-4 rounded-lg primary-hover transition duration-150 shadow-md">
                        Add Category
                    </button>
                </form>
            </div>

            <!-- Current Categories List -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-2xl font-bold text-red-600 mb-4">Expense Categories</h3>
                    <ul id="expenseCategoryList" class="space-y-2">
                        <!-- Expense categories will be populated here -->
                    </ul>
                </div>
                <div class="card">
                    <h3 class="text-2xl font-bold text-green-600 mb-4">Income Categories</h3>
                    <ul id="incomeCategoryList" class="space-y-2">
                        <!-- Income categories will be populated here -->
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <script>
        // Global state and initialization
        const APP_ID = 'wealth_tracker_v1';

        const DEFAULT_CATEGORIES = {
            Expense: [
                "Food & Dining", "Housing", "Transportation", "Utilities", "Healthcare",
                "Entertainment", "Debt Payments", "Personal Care", "Education", "Travel", "Miscellaneous"
            ],
            Income: [
                "Salary", "Investment Income", "Freelance", "Gift", "Other Income"
            ]
        };

        let appState = {
            categories: [], // { name, type, isCustom, id }
            transactions: [], // { date, type, category, description, amount, id }
            banks: [], // { name, type, balance, id }
            stocks: [], // { platform, invested, value, id }
            budget: {
                monthlyNetIncome: 0,
                limits: {} // { 'Category Name': limitAmount }
            }
        };

        let expensesChart, stocksChart;
        let statusTimeout; // For managing the status message visibility

        // Utility Functions

        /**
         * Displays a non-blocking status message in the corner of the screen.
         * Replaces all usage of alert().
         * @param {string} message The message to display.
         * @param {boolean} isError If true, colors the message red.
         */
        function showStatusMessage(message, isError = false) {
            const container = document.getElementById('statusMessageContainer');
            const textElement = document.getElementById('statusMessageText');

            console.log(`[STATUS] ${isError ? 'ERROR' : 'SUCCESS'}: ${message}`); // Debug logging

            // Clear previous timeout
            clearTimeout(statusTimeout);

            // Set content and color
            textElement.textContent = message;
            container.classList.remove('bg-green-600', 'bg-red-600', 'opacity-0');
            container.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
            container.classList.remove('pointer-events-none');
            container.classList.add('opacity-100');

            // Hide after 3 seconds
            statusTimeout = setTimeout(() => {
                container.classList.remove('opacity-100');
                container.classList.add('opacity-0');
                container.classList.add('pointer-events-none');
            }, 3000);
        }


        /**
         * Formats a number into Indian Rupee currency string.
         * @param {number} amount
         * @returns {string} Formatted rupee string (e.g., "₹50,00,000.00").
         */
        function formatRupee(amount) {
            // Ensure non-numeric or null values return a default formatted zero
            if (typeof amount !== 'number' || isNaN(amount)) {
                amount = 0;
            }
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        /**
         * Generates a simple, unique ID.
         * @returns {string}
         */
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // Data Persistence Functions

        /**
         * Loads state from localStorage or initializes defaults.
         */
        function loadData() {
            try {
                const storedState = localStorage.getItem(APP_ID);
                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    appState = { ...appState, ...loadedState };
                }
            } catch (error) {
                console.error("Could not load data from localStorage. Using defaults.", error);
            }

            // Ensure categories are populated (either from loaded data or defaults)
            if (appState.categories.length === 0) {
                initializeDefaultCategories();
            }

            // Ensure budget limits is an object
            if (typeof appState.budget.limits !== 'object' || appState.budget.limits === null) {
                appState.budget.limits = {};
            }

            renderAll();
        }

        /**
         * Saves current state to localStorage.
         */
        function saveData() {
            try {
                localStorage.setItem(APP_ID, JSON.stringify(appState));
            } catch (error) {
                console.error("Could not save data to localStorage.", error);
            }
        }

        // Category Management Logic

        /**
         * Populates the initial default categories.
         */
        function initializeDefaultCategories() {
            appState.categories = [];
            Object.keys(DEFAULT_CATEGORIES).forEach(type => {
                DEFAULT_CATEGORIES[type].forEach(name => {
                    appState.categories.push({
                        name: name,
                        type: type,
                        isCustom: false,
                        id: generateId()
                    });
                });
            });
            saveData();
        }

        /**
         * Renders the category lists and populates category dropdowns.
         */
        function renderCategories() {
            const expList = document.getElementById('expenseCategoryList');
            const incList = document.getElementById('incomeCategoryList');
            expList.innerHTML = '';
            incList.innerHTML = '';

            // Get dropdown elements
            const transCategory = document.getElementById('transCategory');
            const budgetCategory = document.getElementById('budgetCategory');
            transCategory.innerHTML = '<option value="" disabled selected>Select Category</option>';
            budgetCategory.innerHTML = '<option value="" disabled selected>Select Expense Category</option>';

            const sortedCategories = appState.categories.sort((a, b) => a.name.localeCompare(b.name));

            sortedCategories.forEach(cat => {
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center p-2 border-b';
                listItem.innerHTML = `<span>${cat.name}</span>`;

                if (cat.isCustom) {
                    // Add delete button only for custom categories
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&#x2715;'; // Times symbol
                    deleteBtn.className = 'text-red-500 hover:text-red-700 font-bold ml-4';
                    deleteBtn.onclick = () => deleteCategory(cat.id);
                    listItem.appendChild(deleteBtn);
                } else {
                    listItem.innerHTML += '<span class="text-xs text-gray-400 ml-2">(Default)</span>';
                }

                // Populate Category Lists
                if (cat.type === 'Expense') {
                    expList.appendChild(listItem);
                    // Populate Expense Category Dropdown (for budget)
                    budgetCategory.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                } else {
                    incList.appendChild(listItem);
                }

                // Populate Transaction Category Dropdown (for income and expense)
                transCategory.innerHTML += `<option value="${cat.name}" data-type="${cat.type}">${cat.name} (${cat.type})</option>`;
            });

            // Add change listener to filter transaction categories based on type
            const transTypeSelect = document.getElementById('transType');
            transTypeSelect.onchange = filterTransactionCategories;
            // Run initially to set the correct options
            filterTransactionCategories();
        }

        /**
         * Filters the transaction category dropdown based on the selected transaction type.
         */
        function filterTransactionCategories() {
            const selectedType = document.getElementById('transType').value;
            const transCategory = document.getElementById('transCategory');

            // Re-enable all options first
            Array.from(transCategory.options).forEach(option => {
                const optionType = option.getAttribute('data-type');
                if (optionType) {
                    option.hidden = (optionType !== selectedType);
                }
            });

            // Set the selected value to the first available category if the current one is hidden
            if (transCategory.options[transCategory.selectedIndex].hidden) {
                transCategory.selectedIndex = 0; // Reset to "Select Category"
                // Try to auto-select the first visible category
                for (let i = 1; i < transCategory.options.length; i++) {
                    if (!transCategory.options[i].hidden) {
                        transCategory.value = transCategory.options[i].value;
                        break;
                    }
                }
            }
        }

        /**
         * Handles the submission of the Add New Custom Category form.
         * @param {Event} e
         */
        function handleCategoryForm(e) {
            e.preventDefault();
            const name = document.getElementById('categoryName').value.trim();
            const type = document.getElementById('categoryType').value;

            console.log(`[DEBUG] Attempting to add category: "${name}" of type "${type}"`); // Added Debug Log

            if (!name) {
                showStatusMessage("Category name cannot be empty.", true);
                return;
            }

            if (appState.categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
                showStatusMessage("Category name already exists.", true);
                return;
            }

            appState.categories.push({
                name: name,
                type: type,
                isCustom: true,
                id: generateId()
            });

            saveData();
            renderCategories();
            document.getElementById('categoryForm').reset();
            showStatusMessage(`Category "${name}" added successfully.`);
        }

        /**
         * Deletes a custom category and removes it from budget limits.
         * @param {string} id
         */
        function deleteCategory(id) {
            const categoryToDelete = appState.categories.find(cat => cat.id === id);

            // Check if there are transactions using this category
            if (appState.transactions.some(t => t.category === categoryToDelete.name)) {
                showStatusMessage(`Cannot delete category "${categoryToDelete.name}" because transactions are currently using it.`, true);
                return;
            }

            // Remove from categories list
            appState.categories = appState.categories.filter(cat => cat.id !== id);

            // Remove from budget limits if applicable
            if (appState.budget.limits.hasOwnProperty(categoryToDelete.name)) {
                delete appState.budget.limits[categoryToDelete.name];
            }

            showStatusMessage(`Category "${categoryToDelete.name}" deleted.`);
            saveData();
            renderCategories();
            renderBudget();
        }

        // Transaction Logic

        /**
         * Handles the submission of the transaction form.
         * @param {Event} e
         */
        function handleTransactionForm(e) {
            e.preventDefault();

            const transDate = document.getElementById('transDate').value;
            const transType = document.getElementById('transType').value;
            const transCategory = document.getElementById('transCategory').value;
            const transDesc = document.getElementById('transDesc').value.trim();
            const transAmount = parseFloat(document.getElementById('transAmount').value);

            console.log(`[DEBUG] Transaction attempt: ${transType} ${transAmount} for ${transCategory}`);

            if (transAmount <= 0 || !transDate || !transCategory) {
                showStatusMessage("Please fill all fields correctly, including a positive amount and category.", true);
                return;
            }

            appState.transactions.push({
                date: transDate,
                type: transType,
                category: transCategory,
                description: transDesc,
                amount: transAmount,
                id: generateId()
            });

            appState.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date (newest first)
            saveData();
            renderAll(); // Rerender everything to update tables and dashboard
            document.getElementById('transactionForm').reset();
            // Reset date field to current date after submission for convenience
            document.getElementById('transDate').value = new Date().toISOString().substring(0, 10);
            filterTransactionCategories(); // Ensure category dropdown is correct
            showStatusMessage("Transaction added successfully.");
        }

        /**
         * Renders the list of transactions in the table.
         */
        function renderTransactions() {
            const tableBody = document.getElementById('transactionsTableBody');
            tableBody.innerHTML = '';

            // Show only the last 20 transactions
            const recentTransactions = appState.transactions.slice(0, 20);

            if (recentTransactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500 italic">No transactions recorded yet.</td></tr>';
                return;
            }

            recentTransactions.forEach(t => {
                const isExpense = t.type === 'Expense';
                const rowClass = isExpense ? 'text-red-700' : 'text-green-700';
                const typeBadge = isExpense ?
                    '<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-0.5 rounded-full">Expense</span>' :
                    '<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded-full">Income</span>';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                    <td class="px-3 py-3 whitespace-nowrap">${typeBadge}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${t.category}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-600">${t.description}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-right ${rowClass}">${formatRupee(t.amount)}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteTransaction('${t.id}')" class="text-red-500 hover:text-red-700 font-bold" title="Delete Transaction">&times;</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * Deletes a transaction by its ID.
         * @param {string} id
         */
        function deleteTransaction(id) {
            appState.transactions = appState.transactions.filter(t => t.id !== id);
            saveData();
            renderAll();
            showStatusMessage("Transaction deleted.");
        }

        // Bank Account Logic

        /**
         * Handles the submission of the bank account form.
         * @param {Event} e
         */
        function handleBankForm(e) {
            e.preventDefault();
            const name = document.getElementById('bankName').value.trim();
            const type = document.getElementById('bankType').value;
            const balance = parseFloat(document.getElementById('bankBalance').value);

            let message = "";

            // Check if account already exists (update logic)
            const existingBank = appState.banks.find(b => b.name.toLowerCase() === name.toLowerCase());

            if (existingBank) {
                existingBank.type = type;
                existingBank.balance = balance;
                message = `Bank Account "${name}" updated.`;
            } else {
                appState.banks.push({
                    name: name,
                    type: type,
                    balance: balance,
                    id: generateId()
                });
                message = `Bank Account "${name}" added.`;
            }

            saveData();
            renderAll();
            document.getElementById('bankForm').reset();
            showStatusMessage(message);
        }

        /**
         * Renders the list of bank accounts.
         */
        function renderBanks() {
            const bankListDiv = document.getElementById('bankList');
            bankListDiv.innerHTML = ''; // Clear existing content

            if (appState.banks.length === 0) {
                bankListDiv.innerHTML = '<p class="text-gray-500 italic">No bank accounts added yet.</p>';
                return;
            }

            appState.banks.forEach(b => {
                const balanceColor = b.balance >= 0 ? 'text-green-600' : 'text-red-600';
                const bankItem = document.createElement('div');
                bankItem.className = 'p-3 bg-gray-50 rounded-lg shadow-sm flex justify-between items-center';
                bankItem.innerHTML = `
                    <div>
                        <p class="font-medium">${b.name}</p>
                        <p class="text-sm text-gray-500">${b.type}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <p class="font-bold ${balanceColor}">${formatRupee(b.balance)}</p>
                        <button onclick="deleteBank('${b.id}')" class="text-red-400 hover:text-red-600" title="Delete Bank">&times;</button>
                    </div>
                `;
                bankListDiv.appendChild(bankItem);
            });
        }

        /**
         * Deletes a bank account.
         * @param {string} id
         */
        function deleteBank(id) {
            appState.banks = appState.banks.filter(b => b.id !== id);
            saveData();
            renderAll();
            showStatusMessage("Bank account deleted.");
        }

        // Stock Portfolio Logic

        /**
         * Handles the submission of the stock portfolio form.
         * @param {Event} e
         */
        function handleStockForm(e) {
            e.preventDefault();
            const platform = document.getElementById('stockPlatform').value.trim();
            const invested = parseFloat(document.getElementById('stockInvested').value);
            const value = parseFloat(document.getElementById('stockValue').value);

            let message = "";

            // Check if portfolio already exists (update logic)
            const existingStock = appState.stocks.find(s => s.platform.toLowerCase() === platform.toLowerCase());

            if (existingStock) {
                existingStock.invested = invested;
                existingStock.value = value;
                message = `Stock Portfolio for "${platform}" updated.`;
            } else {
                appState.stocks.push({
                    platform: platform,
                    invested: invested,
                    value: value,
                    id: generateId()
                });
                message = `Stock Portfolio for "${platform}" added.`;
            }

            saveData();
            renderAll();
            document.getElementById('stockForm').reset();
            showStatusMessage(message);
        }

        /**
         * Renders the stock portfolio list and summary.
         */
        function renderStocks() {
            const stockListDiv = document.getElementById('stockList');
            stockListDiv.innerHTML = ''; // Clear existing content

            let totalInvested = 0;
            let currentTotalValue = 0;

            if (appState.stocks.length === 0) {
                stockListDiv.innerHTML = '<p class="text-gray-500 italic">No stock portfolios added yet.</p>';
                // Ensure summary still shows zero when list is empty
                document.getElementById('totalInvested').textContent = formatRupee(totalInvested);
                document.getElementById('currentTotalValue').textContent = formatRupee(currentTotalValue);
                document.getElementById('totalPnL').textContent = formatRupee(0);
                document.getElementById('totalPnL').className = `font-bold block text-gray-600`;
                return;
            }


            appState.stocks.forEach(s => {
                totalInvested += s.invested;
                currentTotalValue += s.value;
                const pnl = s.value - s.invested;
                const pnlColor = pnl >= 0 ? 'text-green-600' : 'text-red-600';

                const stockItem = document.createElement('div');
                stockItem.className = 'p-3 bg-gray-50 rounded-lg shadow-sm';
                stockItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-bold text-lg primary-text">${s.platform}</p>
                        <button onclick="deleteStock('${s.id}')" class="text-red-400 hover:text-red-600" title="Delete Portfolio">&times;</button>
                    </div>
                    <div class="grid grid-cols-3 text-sm text-gray-700">
                        <span>Invested: <span class="font-medium">${formatRupee(s.invested)}</span></span>
                        <span>Value: <span class="font-medium">${formatRupee(s.value)}</span></span>
                        <span>P&L: <span class="font-bold ${pnlColor}">${formatRupee(pnl)}</span></span>
                    </div>
                `;
                stockListDiv.appendChild(stockItem);
            });

            // Update Summary
            const totalPnL = currentTotalValue - totalInvested;
            const pnlColor = totalPnL >= 0 ? 'text-green-600' : 'text-red-600';

            document.getElementById('totalInvested').textContent = formatRupee(totalInvested);
            document.getElementById('currentTotalValue').textContent = formatRupee(currentTotalValue);
            document.getElementById('totalPnL').textContent = formatRupee(totalPnL);
            document.getElementById('totalPnL').className = `font-bold block ${pnlColor}`;
        }

        /**
         * Deletes a stock portfolio.
         * @param {string} id
         */
        function deleteStock(id) {
            appState.stocks = appState.stocks.filter(s => s.id !== id);
            saveData();
            renderAll();
            showStatusMessage("Stock portfolio deleted.");
        }

        // Budget Logic

        /**
         * Handles setting the monthly net income.
         * @param {Event} e
         */
        function handleIncomeBudgetForm(e) {
            e.preventDefault();
            appState.budget.monthlyNetIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;
            saveData();
            renderBudget();
            showStatusMessage("Monthly Net Income set successfully!");
        }

        /**
         * Handles setting a category budget limit.
         * @param {Event} e
         */
        function handleBudgetLimitForm(e) {
            e.preventDefault();
            const category = document.getElementById('budgetCategory').value;
            const limit = parseFloat(document.getElementById('budgetLimit').value);

            if (category && limit >= 0) {
                appState.budget.limits[category] = limit;
                saveData();
                renderBudget();
                showStatusMessage(`Budget limit for "${category}" set to ${formatRupee(limit)}.`);
            }
            document.getElementById('budgetLimitForm').reset();
        }

        /**
         * Renders the budget status and progress bars.
         */
        function renderBudget() {
            const incomeDisplay = document.getElementById('totalMonthlyIncomeDisplay').querySelector('span');
            incomeDisplay.textContent = formatRupee(appState.budget.monthlyNetIncome);
            document.getElementById('monthlyIncome').value = appState.budget.monthlyNetIncome;

            const progressContainer = document.getElementById('budgetProgressContainer');
            progressContainer.innerHTML = ''; // Clear existing content

            const limitKeys = Object.keys(appState.budget.limits);

            if (limitKeys.length === 0) {
                // If no budget limits are set, show the placeholder text
                progressContainer.innerHTML = '<p class="text-gray-500 italic">No budget limits have been set yet.</p>';
                return; // Exit the function
            }

            // Calculate current month's expenses by category
            const currentMonth = new Date().toISOString().substring(0, 7);
            const expensesByCat = appState.transactions
                .filter(t => t.type === 'Expense' && t.date.startsWith(currentMonth))
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            limitKeys.forEach(category => {
                const limit = appState.budget.limits[category];
                const spent = expensesByCat[category] || 0;
                const percentage = limit > 0 ? (spent / limit) * 100 : (spent > 0 ? 1000 : 0); // Handle 0 limit case
                const progress = Math.min(percentage, 100);

                let barColor = 'bg-green-500';
                if (percentage >= 100) {
                    barColor = 'bg-red-600'; // Over budget
                } else if (percentage >= 80) {
                    barColor = 'bg-yellow-500'; // Nearing limit
                }

                const progressBar = document.createElement('div');
                progressBar.className = 'space-y-1';
                progressBar.innerHTML = `
                    <div class="flex justify-between text-sm">
                        <span class="font-medium">${category} (Limit: ${formatRupee(limit)})</span>
                        <span class="font-bold ${barColor.replace('bg-', 'text-')}">${formatRupee(spent)} spent</span>
                        <button onclick="delete appState.budget.limits['${category}']; saveData(); renderBudget(); showStatusMessage('Budget limit removed.');" class="text-gray-400 hover:text-red-500 ml-2" title="Delete Limit">&times;</button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full ${barColor}" style="width: ${progress}%"></div>
                    </div>
                    ${percentage > 100 ? `<p class="text-xs text-red-600 font-bold">EXCEEDED BUDGET by ${formatRupee(spent - limit)}</p>` : ''}
                `;
                progressContainer.appendChild(progressBar);
            });
        }

        // Dashboard & Metrics Logic

        /**
         * Calculates and renders the main dashboard metrics.
         */
        function renderDashboard() {
            let totalAssets = 0;
            let totalLiabilities = 0; // For negative bank balances (e.g., credit card debt)

            // Calculate Bank Assets/Liabilities
            const totalBankBalance = appState.banks.reduce((sum, b) => {
                if (b.balance >= 0) totalAssets += b.balance;
                else totalLiabilities += Math.abs(b.balance);
                return sum + b.balance;
            }, 0);

            // Calculate Stock Assets
            const totalStockValue = appState.stocks.reduce((sum, s) => {
                totalAssets += s.value;
                return sum + s.value;
            }, 0);

            // Calculate Net Worth
            const currentNetWorth = totalAssets - totalLiabilities;
            const netWorthDisplay = document.getElementById('netWorthDisplay');
            netWorthDisplay.textContent = formatRupee(currentNetWorth);

            // Calculate Flow Metrics for the current month
            const currentMonth = new Date().toISOString().substring(0, 7);
            const currentMonthTransactions = appState.transactions.filter(t => t.date.startsWith(currentMonth));

            const totalIncome = currentMonthTransactions
                .filter(t => t.type === 'Income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = currentMonthTransactions
                .filter(t => t.type === 'Expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const netFlow = totalIncome - totalExpenses;

            // Render Summary Cards
            const summaries = [
                { title: "Total Income (Mo)", value: totalIncome, color: 'text-green-600' },
                { title: "Total Expenses (Mo)", value: totalExpenses, color: 'text-red-600' },
                { title: "Net Flow (Mo)", value: netFlow, color: netFlow >= 0 ? 'text-green-600' : 'text-red-600' },
                { title: "Total Bank Balance", value: totalBankBalance, color: 'text-indigo-600' },
                { title: "Total Stock Value", value: totalStockValue, color: 'text-purple-600' }
            ];

            const summaryCardsDiv = document.getElementById('summaryCards');
            summaryCardsDiv.innerHTML = summaries.map(s => `
                <div class="card border-l-4 primary-border p-3">
                    <p class="text-sm text-gray-500">${s.title}</p>
                    <p class="text-xl font-bold mt-1 ${s.color}">${formatRupee(s.value)}</p>
                </div>
            `).join('');

            // Update Charts
            updateExpensesChart();
            updateStocksChart();
        }

        // Chart.js Functions

        const CHART_COLORS = [
            '#3F51B5', '#FF9800', '#4CAF50', '#F44336', '#9C27B0',
            '#00BCD4', '#FFEB3B', '#8BC34A', '#795548', '#E91E63',
            '#607D8B', '#03A9F4'
        ];

        /**
         * Renders/updates the Expenses by Category Chart.
         */
        function updateExpensesChart() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const expensesByCat = appState.transactions
                .filter(t => t.type === 'Expense' && t.date.startsWith(currentMonth))
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const labels = Object.keys(expensesByCat);
            const data = Object.values(expensesByCat);

            if (expensesChart) {
                expensesChart.data.labels = labels;
                expensesChart.data.datasets[0].data = data;
                expensesChart.update();
                return;
            }

            const ctx = document.getElementById('expensesChart').getContext('2d');
            expensesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expense Amount (₹)',
                        data: data,
                        backgroundColor: CHART_COLORS,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: false }
                    }
                }
            });
        }

        /**
         * Renders/updates the Stock Portfolio Composition Chart.
         */
        function updateStocksChart() {
            const labels = appState.stocks.map(s => s.platform);
            const data = appState.stocks.map(s => s.value); // Based on current value

            if (stocksChart) {
                stocksChart.data.labels = labels;
                stocksChart.data.datasets[0].data = data;
                stocksChart.update();
                return;
            }

            const ctx = document.getElementById('stocksChart').getContext('2d');
            stocksChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Value (₹)',
                        data: data,
                        backgroundColor: CHART_COLORS,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: false }
                    }
                }
            });
        }

        // Global Render and Initialization

        /**
         * Calls all render functions to update the UI.
         */
        function renderAll() {
            try {
                renderCategories();
                renderTransactions();
                renderDashboard();
                renderBudget();
                renderBanks();
                renderStocks();
                saveData();
            } catch (e) {
                console.error("An error occurred during rendering. This may be why data is not appearing:", e);
                showStatusMessage("A critical error occurred while updating the display. Check console.", true);
            }
        }

        // Clear Data Functionality

        /**
         * Clears all data in localStorage and resets the application state.
         */
        function clearAllData() {
            localStorage.removeItem(APP_ID);
            appState = {
                categories: [],
                transactions: [],
                banks: [],
                stocks: [],
                budget: {
                    monthlyNetIncome: 0,
                    limits: {}
                }
            };
            initializeDefaultCategories(); // Reset to defaults
            renderAll();
            document.getElementById('confirmationModal').classList.add('hidden');
            showStatusMessage("All data has been cleared and reset to default categories.");
        }

        // Event Listeners and Initial Load
        window.onload = function() {
            // Set default date for transaction form
            document.getElementById('transDate').value = new Date().toISOString().substring(0, 10);

            // Load data and render initial UI
            loadData();

            // Set up form handlers
            document.getElementById('categoryForm').addEventListener('submit', handleCategoryForm);
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionForm);
            document.getElementById('bankForm').addEventListener('submit', handleBankForm);
            document.getElementById('stockForm').addEventListener('submit', handleStockForm);
            document.getElementById('incomeBudgetForm').addEventListener('submit', handleIncomeBudgetForm);
            document.getElementById('budgetLimitForm').addEventListener('submit', handleBudgetLimitForm);

            // Set up Clear Data Modal
            const modal = document.getElementById('confirmationModal');
            document.getElementById('clearDataBtn').addEventListener('click', () => {
                modal.classList.remove('hidden');
            });
            document.getElementById('cancelClearBtn').addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            document.getElementById('confirmClearBtn').addEventListener('click', clearAllData);
        };
    </script>

</body>
</html>
